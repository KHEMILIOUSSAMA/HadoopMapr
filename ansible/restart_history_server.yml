---
- hosts: HistoryServer_nodes
  become: yes
  vars_files:
    - ./mapr_configuration/vars/creds.yml   
  tasks:
    - name: Notify relevant users on Slack about HistoryServer restart
      uri:
        url: "{{ slack_webhook_url }}"
        method: POST
        body_format: json
        body: >
          {
            "text": "ğŸš¨ *Avis Important Ã  l'Ã©quipe de dÃ©veloppement de donnÃ©es et aux administrateurs systÃ¨me* ğŸš¨\n\nLe HistoryServer sera redÃ©marrÃ© dans quelques instants pour maintenance. Veuillez terminer toutes les tÃ¢ches critiques ou sauvegarder votre travail en cours.\n\n Le redÃ©marrage peut affecter l'accÃ¨s aux historiques des jobs et les diagnostics temporairement.\n\nNous vous tiendrons informÃ©s une fois la maintenance terminÃ©e. Merci de votre comprÃ©hension et coopÃ©ration."
          }
      delegate_to: localhost

    - name: Stop HistoryServer
      command: sudo maprcli node services -nodes {{ inventory_hostname }} -name historyserver -action stop



    



    - name: Stop HistoryServer
      command: sudo maprcli node services -nodes {{ inventory_hostname }} -name historyserver -action start


    - name: Notify users on Slack that HistoryServer is starting
      uri:
        url: "{{ slack_webhook_url }}"
        method: POST
        body_format: json
        body: >
          {
            "text": "ğŸ”„ *Mise Ã  jour du serveur* ğŸ”„\n\nLe *HistoryServer* est actuellement en cours de redÃ©marrage. Vous pourriez observer des ralentissements temporaires ou des comportements inhabituels dans les analyses et le traitement des jobs MapReduce. Merci de votre patience pendant que nous finalisons la maintenance. Nous nous efforÃ§ons de minimiser les interruptions."
          }
      delegate_to: localhost


    

    - name: Notify users on Slack that HistoryServer is up and running
      uri:
        url: "{{ slack_webhook_url }}"
        method: POST
        body_format: json
        body: >
          {
            "text": "ğŸ‰ *Le HistoryServer est dÃ©sormais opÃ©rationnel!* ğŸ‰\n\nMerci pour votre patience durant cette maintenance. Tous les services sont restaurÃ©s, et vous pouvez dÃ©sormais poursuivre vos activitÃ©s normalement. Bonne continuation !"
          }
      delegate_to: localhost
      when: jps_output.stdout != ""

